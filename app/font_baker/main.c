#include <stdio.h>
#define STB_RECT_PACK_IMPLEMENTATION
#include "stb_rect_pack.h"
#define STB_TRUETYPE_IMPLEMENTATION  // force following include to generate implementation
#include "stb_truetype.h"

#define W 128
#define H 128
#define array_length(arr) (sizeof(arr)/sizeof((arr)[0]))

char ttf_buffer[1<<25];

char* get_char_string(char c) {
    static char s[5] = "\'c\'\0";
    if(c == '\\' || c == '\'' || c == '\"') {
        s[1] = '\\'; s[2] = c; s[3] = '\'';
    } else {
        s[1] = c; s[2] = '\''; s[3] = 0;
    }
    return s;
}


unsigned char pixels[W * H];

#define Q 255,
#define _ 0,

enum {
  MU_ICON_CLOSE = 1,
  MU_ICON_RESIZE,
  MU_ICON_CHECK,
  MU_ICON_COLLAPSED,
  MU_ICON_EXPANDED,
  MU_ICON_MAX
};

unsigned char icons[][26 * 26] = {
    {
        Q Q Q
        Q Q Q
        Q Q Q
    }, {
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ Q _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ Q _ _ Q _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ Q Q _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ Q Q _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ Q _ _ Q _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ Q _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
    }, {
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ Q _ Q _ Q _ Q _ Q _ Q _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
    }, {
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _
        _ _ _ Q _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _
        _ _ _ _ Q _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ Q _ _ _ Q _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ Q _ Q _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
    }, {
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
    }, {
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ Q _ _ _ _ _ Q _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ Q _ _ _ Q _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ Q _ Q _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ Q _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
        _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
    }
};
#undef Q
#undef _

struct stbrp_rect icon_rects[] = {
    [ 0 ] = { 0,  3,  3, 0, 0, 0 },
    [ 1 ] = { 0, 26, 26, 0, 0, 0 },
    [ 2 ] = { 0, 20, 20, 0, 0, 0 },
    [ 3 ] = { 0, 22, 22, 0, 0, 0 },
    [ 4 ] = { 0, 22, 22, 0, 0, 0 },
    [ 5 ] = { 0, 22, 22, 0, 0, 0 },
};

int main(int argc, char **argv) {
    if(argc != 3) return 1;
    stbtt_fontinfo font;
    unsigned char *bitmap;
    fread(ttf_buffer, 1, 1<<25, fopen(argv[1], "rb"));

    stbtt_pack_context spc;
    stbtt_packedchar chardata[96];
    stbtt_PackBegin(&spc, pixels, W, H, 0, 1, 0);
    stbtt_PackFontRange(&spc, ttf_buffer, 0, 14, ' ', 96, chardata);
    stbtt_PackFontRangesPackRects(&spc, icon_rects, array_length(icons));
    stbtt_PackEnd(&spc);

    for(int index = 0; index < array_length(icons); index++) {
        stbrp_rect* rect = &icon_rects[index];
        assert(rect->was_packed);
        int w = rect->w;
        int y = rect->y;
        for(int i = 0; i < rect->h; i++) {
            int y = rect->y + i;
            for(int j = 0; j < rect->w; j++) {
                int x = rect->x + j;
                pixels[y * W + x] = icons[index][i * w + j];
            }
        }        
    }
    
    printf("u8 %s[] = {\n    ", argv[2]);
    for(int i = 0; i < H; i++) {
        for(int j = 0; j < W; j++) {
            printf("0xFF, ");
            printf("0xFF, ");
            printf("0xFF, ");
            printf("0x%02x, ", pixels[W * i + j]);
        }
        printf("\n    ");
    }
    printf("};\n\n");
    printf("int %s_height = %i;\n", argv[2], H);
    printf("int %s_width  = %i;\n\n", argv[2], W);

    printf("GuiPackedChar %s_packed_chars[] = {\n", argv[2]);
    for(char c = ' '; c < 127; c++) {
        stbtt_packedchar* cd = chardata + c - ' ';
        printf("    [%4s ] = { .x0 = %3i, .y0 = %3i, .x1 = %3i, .y1 = %3i, .xoff = %9f, .yoff = %9f, .xadvance = %9f, .xoff2 = %9f, .yoff2 = %9f },\n",
               get_char_string(c), cd->x0 , cd->y0 , cd->x1 , cd->y1 , cd->xoff, cd->yoff, cd->xadvance, cd->xoff2, cd->yoff2);
    }
    printf("};\n\n");

    printf("GuiPackedChar packed_icons[] = {\n");
    for(int i = 0; i < array_length(icons); i++) {
        stbrp_rect* rect = &icon_rects[i];
        printf("    [%4i ] = { .x0 = %3i, .y0 = %3i, .x1 = %3i, .y1 = %3i, .xoff = %9f, .yoff = %9f, .xadvance = %9f, .xoff2 = %9f, .yoff2 = %9f },\n",
               i, rect->x , rect->y , (rect->x + rect->w) , (rect->y + rect->h) , 0.0f, 0.0f, 0.0f, 0.0f, 0.0f);
    }
    printf("};\n");

    return 0;
}
